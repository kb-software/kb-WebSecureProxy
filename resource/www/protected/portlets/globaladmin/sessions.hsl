<!DOCTYPE html PUBLIC "-//W3C//DTD XHTML 1.1//EN" "http://www.w3.org/TR/xhtml11/DTD/xhtml11.dtd">
<html xmlns="http://www.w3.org/1999/xhtml">
<head>
    <xsl:call-template name="html-header"/>
    
    <link rel="stylesheet" href="admin.css"/>
    <script src="admin.js"></script>
	<script src="/public/js/cookies.js"></script>
    <link rel="stylesheet" href="/public/css/buttons.css"/>
    <script>
    /*redirect to equal index.hsl sub-page, if this is the toplevel document*/
    if ( top == self ) {
        top.location = "index.hsl?page="+encodeURIComponent(location.pathname+location.search);
    }
    </script>
    <script>
        /**
         * public function m_forward
         * this function get fired, when user clicks forward button
        */
        function m_forward()
        {
            var strl_last;
            var dsl_row = dsg_table.m_last_row();
            if ( dsl_row && dsl_row.cells.length > 1 ) {
                strl_last = dsl_row.cells[1].firstChild.nodeValue;
            } else {
                strl_last = "0";
            }
            
            dsg_form.m_set_value( document.forms["filterForm"], '<xsl:value-of select="wspadmin/query/display-from"/>', strl_last );
            dsg_form.m_submit( document.forms["filterForm"] );
        } // end of m_forward


        /**
         * public function m_backward
         * this function get fired, when user clicks backward button
        */
        function m_backward()
        {
            var inl_first;
            var strl_first;
            var inl_display;
            var strl_display;
            var dsl_row = dsg_table.m_get_row( 1 );

            if ( dsl_row && dsl_row.cells.length > 1 ) {
                strl_first = dsl_row.cells[1].firstChild.nodeValue;
                if ( strl_first ) {
                    inl_first = parseInt( strl_first, 10 );
                }
            } else {
                strl_first = dsg_query.m_get( '<xsl:value-of select="wspadmin/query/display-from"/>' );
                if ( strl_first ) {
                    inl_first = parseInt( strl_first, 10 );
                }
            }

            strl_display = dsg_form.m_get_value( document.forms["filterForm"], '<xsl:value-of select="wspadmin/query/display-total"/>' );
            if ( strl_display ) {
                inl_display = parseInt( strl_display, 10 );
            }

            if (    !strl_first
                 || !inl_first
                 || !strl_display
                 || !inl_display
                 || !(inl_first - inl_display > -1) ) {
                return false;
            }

            strl_first = (inl_first - 1 - inl_display) + "";
            dsg_form.m_set_value( document.forms["filterForm"], '<xsl:value-of select="wspadmin/query/display-from"/>', strl_first );
            dsg_form.m_submit( document.forms["filterForm"] );
        } // end of m_backward

        /**
         * public function m_autofit
         * this function get fired, when user clicks autofit checkbox
        */
        function m_autofit()
        {
            // initialize some variables:
            var inl_removed;
            var dsl_rt_code;

            if ( dsg_form.m_is_selected( document.forms["filterForm"], 'auto-fit' ) ) {
                // decide where to remove the elements:
                if ( dsg_form.m_get_value(document.forms["filterForm"], '<xsl:value-of select="wspadmin/query/display-from"/>') ) {
                    inl_removed = dsg_table.m_row_auto_fit( false );
                } else {
                    inl_removed = dsg_table.m_row_auto_fit( true );
                }

                // check for errors or nothing done:
                if (    inl_removed == -1
                     || inl_removed ==  0 ) {
                    return;
                }
                dsg_form.m_set_value( document.forms["filterForm"], '<xsl:value-of select="wspadmin/query/display-total"/>', dsg_table.m_count_rows() - 1 + "" );
            }
        } // end of m_autofit


        function m_select_view( ds_event, in_col )
        {
            var dsl_target;

            // get event:
            if ( !ds_event ) {
                ds_event = window.event;
            }

            // get target of click:
            dsl_target = document.all ? ds_event.srcElement : ds_event.target;
            if (    !dsl_target
                 || dsl_target.nodeName.toLowerCase() == "input" ) {
                return false;
            }

            document.getElementById( 'view-' + in_col ).click();
            return false;
        }


        function m_search_log( in_number )
        {
            var strl_link = 'log.hsl?<xsl:value-of select="wspadmin/query/display-total"/>=50&auto-fit=1'
            <xsl:if test="wspadmin/cluster &gt; 1">
                if ( str_handle == "-1" ) {
                    strl_link += '&<xsl:value-of select="wspadmin/query/select-cluster"/>=-1';
                } else {
                    strl_link += '&<xsl:value-of select="wspadmin/query/select-cluster"/>=' + str_handle;
                }
            </xsl:if>            
            strl_link += '&<xsl:value-of select="wspadmin/query/search-word"/>=SNO%3D'

            if ( in_number < 10 ) {
                strl_link += "0";
            }
            if ( in_number < 100 ) {
                strl_link += "0";
            }
            if ( in_number < 1000 ) {
                strl_link += "0";
            }
            if ( in_number < 10000 ) {
                strl_link += "0";
            }
            if ( in_number < 100000 ) {
                strl_link += "0";
            }
            if ( in_number < 1000000 ) {
                strl_link += "0";
            }
            if ( in_number < 10000000 ) {
                strl_link += "0";
            }
            strl_link += in_number;

            document.location.href = strl_link;
        }
    </script>
</head>
<body id="admin-frame" onmousedown="dsg_context.m_hide();">
    <!-- parse search string and get current wsp handle -->
    <script>
        dsg_query.m_init();
        str_handle = dsg_query.m_get('<xsl:value-of select="wspadmin/query/select-cluster"/>');
        if ( str_handle == "" ) {
            str_handle = "0";
        }
    </script>

    <!-- parse cookies -->
    <script>
        dsg_cookies.m_init();
    </script>
    
    <!-- 
        control buttons containing:
            display items
            next page
            search fields
    -->
    <div class="buttons">
        <!-- control form = document.forms["filterForm"] -->
        <form method="GET" accept-charset="UTF-8" id="filterForm">
            <input type="hidden"><xsl:attribute name="name"><xsl:value-of select="wspadmin/query/select-cluster"/></xsl:attribute></input>
            <input type="hidden"><xsl:attribute name="name"><xsl:value-of select="wspadmin/query/display-from"/></xsl:attribute></input>

            <!-- control buttons -->
            <table>
            <!-- search buttons -->
                <tr>
                    <td>
                        <!-- display items -->
                        <div class="cell-left">
                            <span>
                            <xsl:value-of select="lang/html/admin/display-total-before"/>
                            <input type="text" size="3" maxlength="3"><xsl:attribute name="name"><xsl:value-of select="wspadmin/query/display-total"/></xsl:attribute></input>
                            <xsl:value-of select="lang/html/admin/display-total-behind"/>
                            </span><span>
                            <!-- auto fit -->
                            <label for="auto-fit"><xsl:value-of select="lang/html/admin/auto-fit"/></label>
                            <input type="checkbox" name="auto-fit" value="1" onclick="m_autofit();"/>
                            </span>
                        </div>
                        <!-- next page button -->
                        <div class="cell-right">
                            <input type="button" onclick="m_backward();" class="previous"><xsl:attribute name="value"><xsl:value-of select="lang/html/admin/btn-backward"/></xsl:attribute></input>
                            <input type="button" onclick="m_forward();" class="next"><xsl:attribute name="value"><xsl:value-of select="lang/html/admin/btn-forward"/></xsl:attribute></input>
                            <input type="button" class="refresh" onclick="javascript:dsg_timer.m_swap();" id="timer-btn">
                                <xsl:attribute name="value"><xsl:value-of select="lang/html/admin/reload"/></xsl:attribute>
                            </input>
                        </div>
                    </td>
                </tr>
            <!-- search buttons -->
                <tr>
                    <td>
                        <div class="cell-left">
                            <label><xsl:attribute name="for"><xsl:value-of select="wspadmin/query/search-user"/></xsl:attribute>
                                <xsl:value-of select="lang/html/admin/search-txt-user"/>
                            </label>
                            <input type="text"><xsl:attribute name="name"><xsl:value-of select="wspadmin/query/search-user"/></xsl:attribute></input>
                            <label><xsl:attribute name="for"><xsl:value-of select="wspadmin/query/search-usergroup"/></xsl:attribute>
                                <xsl:value-of select="lang/html/admin/search-txt-domain"/>
                            </label>
                            <input type="text"><xsl:attribute name="name"><xsl:value-of select="wspadmin/query/search-usergroup"/></xsl:attribute></input>
                        </div>
                        <div class="cell-right">
                            <input type="submit" class="refresh"><xsl:attribute name="value"><xsl:value-of select="lang/html/admin/btn-reload"/></xsl:attribute></input>
                            <input type="hidden" value="1"><xsl:attribute name="name"><xsl:value-of select="wspadmin/query/search-with-wildcard"/></xsl:attribute></input>
                        </div>
                    </td>
                </tr>

            </table>
        </form>
    </div>

    <!-- disconnect session form  = document.forms[3] -->
    <form method="POST" accept-charset="UTF-8">
        <!--
            connection overview containing
                connection information ( ID, started time, user, group, ... )
                left click menu
                right click (context) menu
        -->
        <div class="admin-content">
            <div class="admin-content-btn">
                <!-- disconnect connections button -->
                <input type="submit" class="userDisabled"><xsl:attribute name="value"><xsl:value-of select="lang/html/admin/sessions/btn-disc-session"/></xsl:attribute></input>
            </div>
            <table id="sessions" class="border">
                <thead>
                    <tr oncontextmenu="return dsg_context.m_show(event,'context-view');">
                        <th onclick="dsg_form.m_swap_select( document.forms[3] );"></th>
                        <script>
                            if ( str_handle == "-1" ) {
                                document.write( '<th><xsl:value-of select="lang/products/wsp-short"/></th>' );
                            }
                        </script>
                        <th><xsl:value-of select="lang/html/admin/sessions/session-number"/></th>
                        <th><xsl:value-of select="lang/html/admin/sessions/time-started"/></th>
                        <th><xsl:value-of select="lang/html/login/user"/></th>
                        <th><xsl:value-of select="lang/html/login/domain"/></th>
                        <th><xsl:value-of select="lang/html/admin/sessions/gate-name"/></th>
                        <th><xsl:value-of select="lang/html/admin/sessions/protocol"/></th>
                        <th><xsl:value-of select="lang/html/admin/sessions/server-entry"/></th>
                        <th><xsl:value-of select="lang/html/admin/sessions/client-ip"/></th>
                        <th><xsl:value-of select="lang/html/admin/sessions/server-ip-port"/></th>
                    </tr>
                </thead>
                <tbody>
                    <xsl:for-each select="wspadmin/session">
                        <tr class="context-menu"><xsl:attribute name="oncontextmenu">return dsg_context.m_show(event,'context-<xsl:value-of select="wspadmin/session/session-number"/>')</xsl:attribute><xsl:attribute name="onclick">return dsg_context.m_show(event,'left-<xsl:value-of select="wspadmin/session/session-number"/>')</xsl:attribute>
                            <td>
                                <input type="checkbox"><xsl:attribute name="name"><xsl:value-of select="wspadmin/query/disconnect-session"/></xsl:attribute><xsl:attribute name="value"><xsl:value-of select="wspadmin/session/session-number"/></xsl:attribute></input>
                                <input type="hidden">
                                    <xsl:attribute name="name"><xsl:value-of select="wspadmin/query/select-cluster"/></xsl:attribute>
                                    <xsl:attribute name="value"><xsl:value-of select="wspadmin/session/current-handle"/></xsl:attribute>
                                </input>
                            </td>
                            <script>
                                if ( str_handle == "-1" ) {
                                    document.write( '<td><xsl:value-of select="wspadmin/session/current-server-name"/></td>' );
                                }
                            </script>
                            <td><xsl:value-of select="wspadmin/session/session-number"/></td>
                            <td><script>dsg_date.m_write(<xsl:value-of select="wspadmin/session/time-started"/>*1000);</script></td>
                            <td><xsl:value-of select="wspadmin/session/user-name"/></td>
                            <td><xsl:value-of select="wspadmin/session/user-group"/></td>
                            <td><xsl:value-of select="wspadmin/session/gate-name"/></td>
                            <td><xsl:value-of select="wspadmin/session/protocol"/></td>
                            <td><xsl:value-of select="wspadmin/session/server-entry"/></td>
                            <td><xsl:value-of select="wspadmin/session/client-ip"/></td>
                            <td><xsl:value-of select="wspadmin/session/server-ip:port"/>

                            </td>
                        </tr>
                    </xsl:for-each>
                </tbody>
            </table>
            <xsl:if test="wspadmin/return-code">
                <script>
                    dsg_form.m_disable( document.forms["filterForm"], '<xsl:value-of select="lang/html/admin/btn-forward"/>' );                        
                </script>
                <br/><xsl:value-of select="wspadmin/return-code"/>
            </xsl:if>

            <!-- click menus -->
            <xsl:for-each select="wspadmin/session">
                <!-- 
                    right click menu
                -->
                <div class="context-menu"><xsl:attribute name="id">context-<xsl:value-of select="wspadmin/session/session-number"/></xsl:attribute>
                    <div class="context-header">
                        <xsl:value-of select="lang/html/admin/sessions/session"/>  <xsl:value-of select="lang/html/admin/sessions/session-number"/> <xsl:value-of select="wspadmin/session/session-number"/>
                    </div>
                    <xsl:if test="wspadmin/session/user-name">
                        <div class="context-line" onmousedown="dsg_context.m_link();">
                            <xsl:attribute name="onclick">dsg_context.m_stop_propagation(event);dsg_form.m_deselect_all( document.forms["filterForm"] );dsg_form.m_set_value( document.forms["filterForm"], '<xsl:value-of select="wspadmin/query/search-user"/>', '<xsl:value-of select="wspadmin/session/user-name"/>' );dsg_form.m_set_value( document.forms["filterForm"], '<xsl:value-of select="wspadmin/query/search-usergroup"/>', '<xsl:value-of select="wspadmin/session/user-group"/>' );dsg_form.m_submit( document.forms["filterForm"] );</xsl:attribute>
                            <div class="context-icon"></div>
                            <div class="context-content"><xsl:value-of select="lang/html/admin/sessions/search-sessions"/> <xsl:value-of select="wspadmin/session/user-group"/>\<xsl:value-of select="wspadmin/session/user-name"/></div>
                        </div>
                        <div class="context-line" onmousedown="dsg_context.m_link();">
                            <xsl:attribute name="onclick">dsg_context.m_stop_propagation(event);dsg_form.m_set_value( document.forms["filterForm"], '<xsl:value-of select="wspadmin/query/search-with-wildcard"/>', '1' );dsg_form.m_set_value( document.forms["filterForm"], '<xsl:value-of select="wspadmin/query/search-user"/>', '*' );dsg_form.m_set_value( document.forms["filterForm"], '<xsl:value-of select="wspadmin/query/search-usergroup"/>', '<xsl:value-of select="wspadmin/session/user-group"/>' );dsg_form.m_submit( document.forms["filterForm"] );</xsl:attribute>
                            <div class="context-icon"></div>
                            <div class="context-content"><xsl:value-of select="lang/html/admin/sessions/search-sessions"/> <xsl:value-of select="wspadmin/session/user-group"/>\*</div>
                        </div>
                        <div class="context-line" onmousedown="dsg_context.m_link();">
                            <xsl:attribute name="onclick">dsg_context.m_stop_propagation(event);dsg_form.m_set_value( document.forms["filterForm"], '<xsl:value-of select="wspadmin/query/search-with-wildcard"/>', '1' );dsg_form.m_set_value( document.forms["filterForm"], '<xsl:value-of select="wspadmin/query/search-user"/>', '<xsl:value-of select="wspadmin/session/user-name"/>' );dsg_form.m_set_value( document.forms["filterForm"], '<xsl:value-of select="wspadmin/query/search-usergroup"/>', '*' );dsg_form.m_submit( document.forms["filterForm"] );</xsl:attribute>
                            <div class="context-icon"></div>
                            <div class="context-content"><xsl:value-of select="lang/html/admin/sessions/search-sessions"/> *\<xsl:value-of select="wspadmin/session/user-name"/></div>
                        </div>
                    </xsl:if>
                    <div class="context-spacer"></div>
                    <div class="context-line" onmousedown="dsg_context.m_link();">
                        <xsl:attribute name="onclick">m_search_log(<xsl:value-of select="wspadmin/session/session-number"/>)</xsl:attribute>
                        <div class="context-icon"></div>
                        <div class="context-content"><xsl:value-of select="lang/html/admin/search-log1"/> <xsl:value-of select="lang/html/admin/sessions/session"/>  <xsl:value-of select="lang/html/admin/sessions/session-number"/> <xsl:value-of select="wspadmin/session/session-number"/> <xsl:value-of select="lang/html/admin/search-log2"/></div>
                    </div>
                    <div class="context-spacer"></div>
                    <div class="context-line" onmousedown="dsg_context.m_link();">
                        <xsl:attribute name="onclick">dsg_context.m_stop_propagation(event);dsg_form.m_select_value(document.forms[3],'<xsl:value-of select="wspadmin/session/session-number"/>', true);dsg_form.m_submit(document.forms[3])</xsl:attribute>
                        <div class="context-icon"></div>
                        <div class="context-content"><xsl:value-of select="lang/html/admin/sessions/end-session"/></div>
                    </div>
                </div>
                <!-- 
                    left click menu
                -->
                <div class="left-menu"><xsl:attribute name="id">left-<xsl:value-of select="wspadmin/session/session-number"/></xsl:attribute>
                    <div class="left-header">
                         <xsl:value-of select="lang/html/admin/sessions/statistics"/>: <xsl:value-of select="lang/html/admin/sessions/session"/> <xsl:value-of select="lang/html/admin/sessions/session-number"/> <xsl:value-of select="wspadmin/session/session-number"/>
                    </div>
                    <div class="left-line">
                        <!-- network statistics -->
                        <table class="statistics">
                            <tr>
                                <td></td>
                                <td colspan="2"><xsl:value-of select="lang/html/admin/sessions/snd"/></td>
                                <td colspan="2"><xsl:value-of select="lang/html/admin/sessions/rec"/></td>
                            </tr>
                            <tr>
                                <td></td>
                                <td><xsl:value-of select="lang/html/admin/sessions/packets"/></td>
                                <td><xsl:value-of select="lang/html/admin/sessions/data"/></td>
                                <td><xsl:value-of select="lang/html/admin/sessions/packets"/></td>
                                <td><xsl:value-of select="lang/html/admin/sessions/data"/></td>
                            </tr>
                            <!-- encrypted data -->
                            <tr>
                                <td><xsl:value-of select="lang/html/admin/sessions/encrypted"/></td>
                                <td><xsl:value-of select="wspadmin/session/number-snd-encrypted"/></td>
                                <td><xsl:value-of select="wspadmin/session/data-snd-encrypted"/></td>
                                <td><xsl:value-of select="wspadmin/session/number-rec-encrypted"/></td>
                                <td><xsl:value-of select="wspadmin/session/data-rec-encrypted"/></td>
                            </tr>
                            <!-- client data -->
                            <tr>
                                <td><xsl:value-of select="lang/html/admin/sessions/client"/></td>
                                <td><xsl:value-of select="wspadmin/session/number-snd-client"/></td>
                                <td><xsl:value-of select="wspadmin/session/data-snd-client"/></td>
                                <td><xsl:value-of select="wspadmin/session/number-rec-client"/></td>
                                <td><xsl:value-of select="wspadmin/session/data-rec-client"/></td>
                            </tr>
                            <xsl:if test="wspadmin/session/server-ip:port">
                            <!-- server data -->
                            <tr>
                                <td><xsl:value-of select="lang/html/admin/sessions/server"/></td>
                                <td><xsl:value-of select="wspadmin/session/number-snd-server"/></td>
                                <td><xsl:value-of select="wspadmin/session/data-snd-server"/></td>
                                <td><xsl:value-of select="wspadmin/session/number-rec-server"/></td>
                                <td><xsl:value-of select="wspadmin/session/data-rec-server"/></td>
                            </tr>
                            </xsl:if>
                        </table>
                    </div>
                </div>
            </xsl:for-each>
        </div>
    </form>
    
    <!-- fill form with values from url -->
    <script>
        dsg_query.m_fill( document.forms["filterForm"] );
    </script>

    <script>
        dsg_timer.m_init( 30, null,
                          '<xsl:value-of select="lang/html/admin/reload-in"/>', '<xsl:value-of select="lang/html/admin/reload-sec"/>',
                          document.getElementById('timer-btn'), '<xsl:value-of select="lang/html/admin/reload"/>' );
        dsg_timer.m_auto_start();

        dsg_table.m_init("sessions");
        dsg_table.m_col_auto_hide();
        m_autofit();

        dsg_sort.m_init( document.getElementById("sessions") );
        dsg_sort.m_sort_column( 1 ); // sort by ID
    </script>
    
    <!-- disable backward button -->
    <script>
        var inl_start;
        var inl_first;
        var dsl_row = dsg_table.m_get_row( 1 );

        if ( dsl_row && dsl_row.cells.length > 1 ) {
            inl_first   = parseInt( dsl_row.cells[1].firstChild.nodeValue, 10 );
            inl_start   = parseInt( dsg_form.m_get_value(document.forms["filterForm"], '<xsl:value-of select="wspadmin/query/display-from"/>'), 10 );
            if ( !inl_start ) {
                inl_start = 0;
            }
            
            if (    inl_first     > -1
                 && inl_first -1 != inl_start ) {
                dsg_form.m_disable( document.forms["filterForm"], '<xsl:value-of select="lang/html/admin/btn-backward"/>' );
            }
        }
    </script>
    
    <!-- columns context menu -->
    <div class="context-menu" id="context-view">
        <div class="context-header">
            <xsl:value-of select="lang/html/admin/select-column"/>
        </div>
        <script>
            var inl_col;
            var dsl_names = dsg_table.m_get_col_names();
            for ( inl_col = 1; inl_col < dsl_names.length; inl_col++ ) {
                document.write( '<div class="context-line" onmousedown="dsg_context.m_link();" onclick="m_select_view(event,'+ inl_col +');">' );
                document.write( '<div class="context-icon">' );
                document.write( '<input id="view-' + inl_col + '" type="checkbox" onclick="dsg_table.m_swap_col(' + inl_col + ');"' );
                if ( dsg_table.m_col_visible(inl_col) ) {
                    document.write( ' checked="checked"' );
                }
                document.write( '/>' );
                document.write( '</div>' );
                document.write( '<div class="context-content">' );
                document.write( dsl_names[inl_col] );
                document.write( '</div>' );
                document.write( '</div>' );
            }
        </script>
    </div>
</body>
</html>

<xsl:include href="/public/template_header.hsl" />
